<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConsultationDB Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>body{font-family:'Plus Jakarta Sans',sans-serif;background:#0f172a;color:white;}</style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div class="w-full max-w-2xl bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">
        <div class="bg-indigo-600 p-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl text-white"><i class="fa-solid fa-server"></i></div>
                <div>
                    <h1 class="text-xl font-bold">ConsultationDB Platform</h1>
                    <p class="text-indigo-200 text-sm">Mother Interface (Directory)</p>
                </div>
            </div>
            <button onclick="fetchUsers()" class="text-white hover:bg-white/10 p-2 rounded-lg transition"><i class="fa-solid fa-rotate"></i></button>
        </div>

        <div class="p-6 space-y-8">
            
            <!-- ADMIN CONTROLS (Create New) -->
            <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-3"><i class="fa-solid fa-lock text-indigo-500 mr-1"></i> Admin Controls (Requires Master Key)</label>
                <div class="flex gap-2">
                    <input type="text" id="newUserName" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-indigo-500 transition text-white" placeholder="New Database Name (e.g. Resident_A)">
                    <button onclick="triggerAdminAction('create')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold text-sm transition shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Create
                    </button>
                </div>
            </div>

            <!-- DATABASE LIST -->
            <div>
                <div class="flex justify-between items-end mb-3">
                    <label class="block text-xs font-bold text-slate-400 uppercase">Available Databases</label>
                    <span class="text-xs text-slate-500" id="dbCount">Loading...</span>
                </div>
                <div id="userList" class="bg-slate-900 rounded-xl border border-slate-700 max-h-[400px] overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
                    <div class="p-8 text-center text-slate-500 text-sm">
                        <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i><br>Connecting to System...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PASSWORD MODAL -->
    <div id="adminModal" class="fixed inset-0 bg-slate-900/90 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-2xl w-80 text-center animate-bounce-in">
            <div class="w-12 h-12 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-shield-halved"></i></div>
            <h3 class="text-white font-bold mb-1">Admin Authorization</h3>
            <p class="text-slate-400 text-xs mb-4">Enter Master Key to proceed</p>
            <input type="password" id="adminPin" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-3 text-center tracking-widest text-lg mb-4 text-white focus:border-indigo-500 outline-none" placeholder="PIN">
            <div class="flex gap-2">
                <button onclick="closeAdminModal()" class="flex-1 py-2 text-slate-400 hover:text-white text-sm font-bold">Cancel</button>
                <button onclick="submitAdminAction()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-lg font-bold transition shadow-lg">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const API_URL = "https://script.google.com/macros/s/AKfycbzvnNr78eq_mRDQNeJuTGpLlu1_Lbfxxm5Pif1XZkrYxpOfpRIqVAbZJKIUpmR-mrzVNQ/exec";
        
        // *** CRITICAL UPDATE: Pointing to app.html instead of root ***
        const APP_BASE_URL = "https://wasupon-sri.github.io/clinicalDB/app.html"; 
        
        let pendingAction = null;
        let pendingPayload = null;

        window.onload = () => { fetchUsers(); };

        async function fetchUsers() {
            const list = document.getElementById('userList');
            const count = document.getElementById('dbCount');
            
            try {
                const res = await fetch(API_URL + "?action=admin_list_users");
                const json = await res.json();
                
                if(json.users) {
                    list.innerHTML = '';
                    count.innerText = `${json.users.length} Active`;
                    
                    json.users.forEach(u => {
                        // Logic: If Sheet1, use base URL. If Friend, append query param.
                        const link = u === 'Sheet1' ? APP_BASE_URL : `${APP_BASE_URL}?db=${u}`;
                        const isMe = u === 'Sheet1';
                        const displayName = isMe ? 'Main Database (Sheet1)' : u;
                        const iconClass = isMe ? 'text-emerald-400 bg-emerald-500/10' : 'text-indigo-400 bg-indigo-500/10';
                        
                        const item = document.createElement('div');
                        item.className = "flex items-center justify-between p-4 border-b border-slate-800 hover:bg-slate-800/50 transition last:border-0";
                        
                        item.innerHTML = `
                            <div class="flex items-center gap-4 min-w-0">
                                <div class="w-10 h-10 rounded-lg ${iconClass} flex items-center justify-center shrink-0">
                                    <i class="fa-solid fa-database"></i>
                                </div>
                                <div class="truncate">
                                    <h3 class="font-bold text-slate-200 truncate">${displayName}</h3>
                                    <div class="text-xs text-slate-500 font-mono truncate flex items-center gap-1">
                                        <span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span> Online
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                <a href="${link}" target="_blank" class="px-4 py-2 bg-slate-700 hover:bg-indigo-600 text-white text-xs font-bold rounded-lg transition flex items-center gap-2">
                                    <i class="fa-solid fa-arrow-up-right-from-square"></i> Open App
                                </a>
                                <button onclick="copyLink('${link}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-800 hover:bg-white hover:text-slate-900 text-slate-400 border border-slate-700 transition" title="Copy Link">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                                ${!isMe ? `<button onclick="triggerAdminAction('delete', '${u}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-800 hover:bg-rose-500 hover:text-white text-rose-500 border border-slate-700 transition" title="Delete Database"><i class="fa-solid fa-trash"></i></button>` : ''}
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            } catch(e) {
                list.innerHTML = `<div class="p-8 text-center text-rose-400 text-sm">Connection Failed. Check URL.<br>${e.message}</div>`;
            }
        }

        function triggerAdminAction(type, targetName = null) {
            if (type === 'create') {
                const name = document.getElementById('newUserName').value.trim().replace(/[^a-zA-Z0-9_-]/g, '');
                if (!name) return alert("Enter a valid name (Letters, Numbers, _ only)");
                pendingAction = 'admin_create_user';
                pendingPayload = { dbName: name };
            } else if (type === 'delete') {
                if(!confirm(`PERMANENTLY DELETE database "${targetName}"? Data will be lost.`)) return;
                pendingAction = 'admin_delete_user';
                pendingPayload = { dbName: targetName };
            }
            
            document.getElementById('adminPin').value = '';
            document.getElementById('adminModal').classList.remove('hidden');
            document.getElementById('adminModal').classList.add('flex');
            document.getElementById('adminPin').focus();
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.add('hidden');
            document.getElementById('adminModal').classList.remove('flex');
            pendingAction = null;
        }

        async function submitAdminAction() {
            const pin = document.getElementById('adminPin').value;
            if(!pin) return;
            
            const btn = document.querySelector('#adminModal button:last-child');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: pendingAction, 
                        adminKey: pin, 
                        ...pendingPayload 
                    })
                });
                const json = await res.json();
                
                if(json.status === 'success') {
                    closeAdminModal();
                    if(pendingAction === 'admin_create_user') document.getElementById('newUserName').value = '';
                    fetchUsers();
                } else {
                    alert(json.error || "Action Failed");
                    document.getElementById('adminPin').value = '';
                }
            } catch(e) {
                alert("Network Error: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        function copyLink(url) {
            navigator.clipboard.writeText(url);
            const btn = event.currentTarget;
            const icon = btn.querySelector('i');
            icon.className = "fa-solid fa-check text-emerald-400";
            setTimeout(() => icon.className = "fa-regular fa-copy", 1500);
        }
    </script>
</body>
</html>
