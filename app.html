<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ConsultationDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'Sarabun', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }, // Futuristic Blue
                        rose: { 50: '#fff1f2', 100: '#ffe4e6', 500: '#f43f5e', 600: '#e11d48', 700: '#be123c' },
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.05)',
                        'glow': '0 0 15px rgba(59, 130, 246, 0.3)',
                        'float': '0 10px 30px -10px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    <style>
        /* Modern Background Gradient */
        body { 
            background: radial-gradient(circle at 50% 0%, #f1f5f9 0%, #f8fafc 100%);
            color: #334155; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }

        /* Glassmorphism Classes */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        }

        .glass-card {
            background: white;
            border: 1px solid #f1f5f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            border-color: #e2e8f0;
        }

        /* Calendar Grid Styling */
        #calendarGrid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem; /* Gap between floating cards */
            padding: 0.5rem;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Form Elements */
        .input-glass { 
            width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 0.95rem; color: #1e293b; 
            transition: all 0.2s; 
        }
        .input-glass:focus { outline: none; border-color: #f43f5e; background: white; box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1); }

        /* Large Textbox */
        .textarea-glass { 
            @apply w-full bg-slate-50 border border-slate-200 rounded-2xl p-6 text-slate-800 leading-relaxed;
            font-size: 1.15rem; height: 450px !important; width: 100% !important; resize: none;
            transition: all 0.2s; display: block;
        }
        .textarea-glass:focus { outline: none; border-color: #f43f5e; background: white; box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1); }

        /* Utilities */
        .hidden { display: none !important; }
        .loader { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-bottom-color: #f43f5e; border-radius: 50%; animation: rotation 0.8s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Checkbox */
        .custom-check { appearance: none; width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 6px; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
        .custom-check:checked { background: #f43f5e; border-color: #f43f5e; transform: scale(1.1); }
        .custom-check::before { content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 12px; color: white; transform: scale(0); transition: 0.2s; }
        .custom-check:checked::before { transform: scale(1); }

        /* Swipe Actions */
        .swipe-item-container { position: relative; overflow: hidden; border-radius: 1rem; margin-bottom: 0.75rem; background-color: #ef4444; }
        .swipe-content { position: relative; background: white; z-index: 20; transition: transform 0.2s ease-out; width: 100%; border-radius: 1rem; border: 1px solid #f1f5f9; box-shadow: 0 2px 5px rgba(0,0,0,0.03); touch-action: pan-y; }
        .swipe-actions { position: absolute; top: 0; bottom: 0; right: 0; width: 80px; z-index: 10; display: flex; align-items: center; justify-content: center; }

        /* Expanded Note */
        .expanded-note { position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; width: 95vw !important; height: 95vh !important; z-index: 9999 !important; font-size: 1.5rem !important; border-radius: 1rem !important; box-shadow: 0 0 0 100vmax rgba(15, 23, 42, 0.85) !important; border-color: var(--p-600) !important; border-width: 4px !important; padding: 3rem !important; margin: 0 !important; max-width: none !important; max-height: none !important; }

        /* Context Icons */
        .ctx-btn { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; background: white; color: #94a3b8; transition: all 0.2s; cursor: pointer; }
        .ctx-btn.active { background: #f43f5e; color: white; border-color: #f43f5e; box-shadow: 0 4px 10px rgba(244, 63, 94, 0.3); transform: translateY(-2px); }
        .ctx-btn:hover:not(.active) { background: #f8fafc; color: #64748b; }

        /* Color Circles */
        .color-btn { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; flex-shrink: 0; }
        .color-btn:hover { transform: scale(1.15); }
        .color-btn.active { border-color: #f43f5e; transform: scale(1.15); box-shadow: 0 0 0 2px white, 0 0 0 4px #f43f5e; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden font-sans text-slate-600">

    <!-- AUTH OVERLAY -->
    <div id="authOverlay" class="fixed inset-0 z-[200] bg-slate-50/80 backdrop-blur-xl flex items-center justify-center">
        <div class="bg-white p-10 rounded-[2rem] shadow-float w-full max-w-sm text-center relative border border-slate-100">
            <div class="w-20 h-20 bg-gradient-to-br from-rose-400 to-rose-600 rounded-3xl flex items-center justify-center mx-auto mb-6 text-white text-3xl shadow-lg shadow-rose-500/30 transform rotate-3">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            
            <div id="authSetup" class="hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome</h2>
                <p class="text-slate-500 text-sm mb-6">Create a secure PIN for <br><span id="dbNameSetup" class="font-bold text-rose-600 bg-rose-50 px-2 py-0.5 rounded-md"></span></p>
                <input type="password" id="createPin" class="input-glass text-center text-2xl tracking-[0.5em] font-bold mb-4" placeholder="••••" maxlength="4" inputmode="numeric">
                <button onclick="setupPassword()" id="btnSetup" class="w-full py-3.5 bg-slate-900 hover:bg-slate-800 text-white font-bold rounded-2xl shadow-lg transition transform active:scale-95">Set PIN Code</button>
            </div>

            <div id="authLogin" class="hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Locked</h2>
                <p class="text-slate-500 text-sm mb-6">Enter PIN to access <br><span id="dbNameLogin" class="font-bold text-rose-600 bg-rose-50 px-2 py-0.5 rounded-md"></span></p>
                <input type="password" id="loginPin" class="input-glass text-center text-2xl tracking-[0.5em] font-bold mb-4" placeholder="••••" maxlength="4" inputmode="numeric">
                <button onclick="verifyPassword()" id="btnLogin" class="w-full py-3.5 bg-slate-900 hover:bg-slate-800 text-white font-bold rounded-2xl shadow-lg transition transform active:scale-95">Unlock Database</button>
                <p id="loginError" class="text-rose-500 text-xs mt-4 hidden font-bold animate-pulse"><i class="fa-solid fa-circle-exclamation mr-1"></i> Incorrect PIN</p>
            </div>
            
            <div id="authLoading">
                <div class="loader mx-auto mb-4"></div>
                <p class="text-slate-400 text-sm font-medium tracking-wide">SECURE CONNECTION</p>
            </div>

            <div id="authError" class="hidden">
                <div class="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500 text-2xl"><i class="fa-solid fa-wifi"></i></div>
                <h3 class="text-lg font-bold text-slate-800">Connection Failed</h3>
                <p id="errorDetail" class="text-xs text-slate-500 mb-6 mt-2">Could not reach the secure server.</p>
                <button onclick="location.reload()" class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl text-sm">Retry Connection</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="appContainer" class="h-full flex flex-col hidden">
        
        <!-- HEADER (Floating) -->
        <div class="px-4 pt-4 pb-2 z-30">
            <header class="h-18 glass-panel rounded-2xl flex items-center justify-between px-5 py-3">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-rose-600 rounded-2xl flex items-center justify-center shadow-lg shadow-rose-500/20 text-white transform hover:scale-105 transition duration-300 cursor-pointer" onclick="manualRefresh()">
                        <i class="fa-solid fa-user-doctor text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg text-slate-800 leading-tight tracking-tight" id="appTitle">ConsultationDB</h1>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span id="statusDot" class="w-2 h-2 rounded-full bg-slate-300"></span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider" id="syncStatus">Ready</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex bg-slate-100/80 p-1.5 rounded-xl border border-slate-200/50 backdrop-blur-sm">
                    <button onclick="switchView('calendar')" id="btnViewCal" class="w-10 h-10 rounded-lg flex items-center justify-center transition font-medium text-slate-500 hover:text-slate-800"><i class="fa-regular fa-calendar-days text-lg"></i></button>
                    <button onclick="switchView('wards')" id="btnViewWard" class="w-10 h-10 rounded-lg text-slate-400 flex items-center justify-center transition hover:text-slate-800"><i class="fa-solid fa-layer-group text-lg"></i></button>
                </div>
            </header>
        </div>

        <!-- MAIN VIEW AREA -->
        <main class="flex-1 relative overflow-hidden">
            
            <!-- CALENDAR VIEW -->
            <div id="viewCalendar" class="absolute inset-0 flex flex-col transition-transform duration-500 p-2">
                <div class="flex justify-between items-center mb-2 px-4 py-2">
                    <h2 id="monthLabel" class="text-2xl font-extrabold text-slate-800 tracking-tight">Loading...</h2>
                    <div class="flex items-center gap-2 bg-white/60 p-1 rounded-xl border border-slate-200 backdrop-blur-sm">
                        <button onclick="changeMonth(-1)" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-white hover:shadow-sm text-slate-500 transition"><i class="fa-solid fa-chevron-left"></i></button>
                        <button onclick="goToToday()" class="px-4 h-9 text-xs font-bold text-slate-600 hover:bg-white hover:shadow-sm rounded-lg uppercase tracking-wide transition">Today</button>
                        <button onclick="changeMonth(1)" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-white hover:shadow-sm text-slate-500 transition"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- Days Header -->
                <div class="grid grid-cols-7 text-center mb-2 px-2">
                    <div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Sun</div>
                    <div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Mon</div>
                    <div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Tue</div>
                    <div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Wed</div>
                    <div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Thu</div>
                    <div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Fri</div>
                    <div class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Sat</div>
                </div>

                <!-- Calendar Grid (Cards) -->
                <div id="calendarGrid" class="flex-1 overflow-y-auto pb-20 px-2">
                    <!-- JS Injected Here -->
                </div>
            </div>

            <!-- WARDS VIEW -->
            <div id="viewWards" class="absolute inset-0 translate-x-full transition-transform duration-500 p-6 overflow-y-auto">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-2xl bg-emerald-100 flex items-center justify-center text-emerald-600 text-xl"><i class="fa-solid fa-building-user"></i></div>
                    <h2 class="text-2xl font-bold text-slate-800">Ward Matrix</h2>
                </div>
                <div id="wardGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                    <!-- JS Injected Here -->
                </div>
            </div>
        </main>

        <!-- FLOATING ACTION BUTTON (Mobile) -->
        <button onclick="openEditor()" class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-rose-600 text-white rounded-2xl shadow-xl shadow-rose-600/30 flex items-center justify-center z-30 transform hover:scale-110 active:scale-95 transition duration-300">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>
    </div>

    <!-- PORTAL (SIDE PANEL) -->
    <div id="portalModal" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-slate-900/10 backdrop-blur-sm transition-opacity" onclick="closePortal()"></div>
        <div class="absolute inset-y-0 right-0 w-full md:w-[480px] bg-white shadow-2xl transition-transform transform translate-x-full duration-500 flex flex-col" id="portalPanel">
            
            <div class="px-8 py-6 border-b border-slate-100 bg-white/95 backdrop-blur z-10 flex justify-between items-start">
                <div>
                    <h3 id="portalTitle" class="text-3xl font-extrabold text-slate-800 tracking-tight">Details</h3>
                    <p id="portalSubtitle" class="text-slate-400 text-sm font-medium mt-1">Daily Records</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleBatchMode()" id="btnBatch" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition flex items-center justify-center"><i class="fa-solid fa-list-check"></i></button>
                    <button onclick="closePortal()" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-slate-100 transition flex items-center justify-center"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
            </div>

            <div id="portalList" class="flex-1 overflow-y-auto p-6 space-y-4 bg-[#f8fafc]">
                <!-- List Items JS -->
            </div>

            <!-- Batch Actions Toolbar -->
            <div id="batchToolbar" class="hidden shrink-0 px-8 py-5 bg-white border-t border-slate-100 flex justify-between items-center shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)]">
                <span class="text-sm font-bold text-slate-700"><span id="batchCount" class="text-indigo-600 text-lg">0</span> selected</span>
                <div class="flex gap-3">
                    <button onclick="exportBatch()" class="px-4 py-2.5 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold transition hover:bg-indigo-100 flex items-center gap-2"><i class="fa-solid fa-download"></i> Export</button>
                    <button onclick="executeBatchDelete()" class="px-4 py-2.5 bg-rose-50 text-rose-600 rounded-xl text-xs font-bold transition hover:bg-rose-100 flex items-center gap-2"><i class="fa-regular fa-trash-can"></i> Delete</button>
                </div>
            </div>

            <!-- Standard Footer -->
            <div class="p-8 border-t border-slate-100 bg-white shrink-0" id="portalFooter">
                <button onclick="openEditor()" class="w-full py-4 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 text-white rounded-2xl font-bold shadow-lg shadow-rose-500/20 flex items-center justify-center gap-3 transition transform active:scale-[0.98]">
                    <i class="fa-solid fa-plus"></i> New Record
                </button>
            </div>
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div id="editorModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 sm:p-6">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-md transition-opacity" onclick="closeEditor()"></div>
        
        <!-- Modal Card -->
        <div class="relative w-full max-w-3xl bg-white rounded-3xl shadow-2xl flex flex-col max-h-[92vh] overflow-hidden animate-zoomIn ring-1 ring-slate-900/5">
            
            <!-- Header -->
            <div class="px-8 py-5 border-b border-slate-100 bg-white flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-2xl bg-rose-50 text-rose-600 flex items-center justify-center text-lg shadow-sm">
                        <i class="fa-solid fa-pen-nib"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-800" id="editorMode">New Record</h3>
                        <p class="text-xs text-slate-400 font-medium">Consultation Details</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportCurrentRecord()" id="btnExportSingle" class="hidden sm:flex items-center gap-2 px-4 py-2 bg-slate-50 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-100 transition"><i class="fa-solid fa-file-export"></i> Export</button>
                    <button onclick="closeEditor()" class="w-9 h-9 rounded-full hover:bg-slate-100 text-slate-400 transition flex items-center justify-center"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
            </div>

            <!-- Body -->
            <div class="p-8 overflow-y-auto space-y-8 bg-[#ffffff]">
                
                <!-- Top Row: Date & Ward -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Date</label>
                        <div class="relative group">
                            <input type="date" id="editTimestamp" class="input-glass pl-11 font-medium bg-slate-50 border-transparent focus:bg-white focus:border-rose-200 focus:ring-4 focus:ring-rose-50">
                            <i class="fa-regular fa-calendar-days absolute left-4 top-3.5 text-slate-400 group-hover:text-rose-500 transition"></i>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center pl-1 pr-1">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Ward / Unit</label>
                            <div class="flex items-center gap-2 bg-rose-50 px-2 py-1 rounded-lg">
                                <input type="checkbox" id="editDischarged" class="custom-check">
                                <label for="editDischarged" class="text-[10px] font-bold text-rose-600 cursor-pointer uppercase tracking-wide">Discharge</label>
                            </div>
                        </div>
                        <div class="relative group">
                            <input type="text" id="editWard" list="wardSuggestions" placeholder="Select or type..." class="input-glass pl-11 font-medium bg-slate-50 border-transparent focus:bg-white focus:border-rose-200 focus:ring-4 focus:ring-rose-50">
                            <i class="fa-solid fa-hospital absolute left-4 top-3.5 text-slate-400 group-hover:text-rose-500 transition"></i>
                            <datalist id="wardSuggestions"></datalist>
                        </div>
                    </div>
                </div>

                <!-- Context Grid -->
                <div class="space-y-3">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Context</label>
                    <div class="flex flex-wrap gap-3" id="iconPicker"></div>
                    <input type="hidden" id="editIcon">
                </div>

                <!-- Color Palette -->
                <div class="space-y-3">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Priority Label</label>
                    <div class="flex flex-wrap gap-4 px-2" id="colorPicker"></div>
                    <input type="hidden" id="editColor">
                </div>

                <!-- Large Text Area -->
                <div class="flex-1 flex flex-col space-y-2"> 
                    <div class="flex justify-between items-end pl-1 pr-1">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Clinical Notes</label>
                        <button onclick="toggleExpandNote()" class="text-xs text-rose-500 font-bold hover:text-rose-700 flex items-center gap-1 bg-rose-50 px-2 py-1 rounded-lg transition"><i class="fa-solid fa-expand"></i> Full Screen</button>
                    </div>
                    <input type="text" id="editName" class="input-glass font-bold text-lg mb-2 bg-slate-50 border-transparent placeholder:text-slate-300" placeholder="Record Name (e.g. Data_001)">
                    <textarea id="editContent" ondblclick="toggleExpandNote()" class="textarea-glass focus:ring-4 focus:ring-rose-50" placeholder="Type detailed progress note here..."></textarea>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-8 py-5 border-t border-slate-100 bg-white flex justify-between items-center z-20">
                <button type="button" onclick="deleteRecord()" id="btnDeleteRecord" class="text-rose-500 hover:text-white hover:bg-rose-500 text-xs font-bold px-5 py-3 rounded-xl transition hidden flex items-center gap-2 border border-rose-100 hover:border-rose-500"><i class="fa-regular fa-trash-can"></i> Delete</button>
                <div class="flex gap-4 ml-auto">
                    <button onclick="closeEditor()" class="px-6 py-3 text-slate-500 hover:text-slate-800 font-bold transition text-sm">Cancel</button>
                    <button onclick="saveRecord()" id="btnSave" class="px-8 py-3 bg-gradient-to-r from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 text-white rounded-xl font-bold shadow-lg shadow-rose-200/50 transition transform active:scale-[0.98] text-sm flex items-center gap-2"><i class="fa-solid fa-check"></i> Save Record</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Exit Full Screen Button -->
    <button id="btnExitExpand" onclick="toggleExpandNote(false)" class="hidden fixed top-6 right-6 z-[10000] bg-white/90 backdrop-blur text-slate-800 px-6 py-3 rounded-full shadow-2xl border border-slate-200 font-bold hover:bg-rose-50 hover:text-rose-600 transition flex items-center gap-3 animate-bounce">
        <i class="fa-solid fa-compress text-lg"></i> <span>Exit Focus Mode</span>
    </button>

    <script>
        // CONFIG
        const API_URL = "https://script.google.com/macros/s/AKfycbzvnNr78eq_mRDQNeJuTGpLlu1_Lbfxxm5Pif1XZkrYxpOfpRIqVAbZJKIUpmR-mrzVNQ/exec";
        const POLLING_INTERVAL = 5000;
        let USER_PASSWORD = ""; 
        
        // ICONS & COLORS (15 Pastels + Slate)
        const ICONS = [
            {id:'heart-pulse',icon:'fa-heart-pulse'}, {id:'lungs',icon:'fa-lungs'}, {id:'brain',icon:'fa-brain'}, {id:'virus',icon:'fa-virus'}, 
            {id:'pills',icon:'fa-pills'}, {id:'syringe',icon:'fa-syringe'}, {id:'user-doctor',icon:'fa-user-doctor'}, {id:'clipboard',icon:'fa-clipboard-list'}, 
            {id:'skull',icon:'fa-skull'}, {id:'flask',icon:'fa-flask'}, {id:'file-medical',icon:'fa-file-medical'}, {id:'bed',icon:'fa-bed'}
        ];
        const COLORS = [
            {id:'slate',bg:'bg-slate-500',ring:'ring-slate-200'}, {id:'red',bg:'bg-red-400',ring:'ring-red-200'}, {id:'orange',bg:'bg-orange-400',ring:'ring-orange-200'}, {id:'amber',bg:'bg-amber-400',ring:'ring-amber-200'},
            {id:'yellow',bg:'bg-yellow-400',ring:'ring-yellow-200'}, {id:'lime',bg:'bg-lime-400',ring:'ring-lime-200'}, {id:'green',bg:'bg-green-400',ring:'ring-green-200'}, {id:'emerald',bg:'bg-emerald-400',ring:'ring-emerald-200'},
            {id:'teal',bg:'bg-teal-400',ring:'ring-teal-200'}, {id:'cyan',bg:'bg-cyan-400',ring:'ring-cyan-200'}, {id:'sky',bg:'bg-sky-400',ring:'ring-sky-200'}, {id:'blue',bg:'bg-blue-400',ring:'ring-blue-200'},
            {id:'indigo',bg:'bg-indigo-400',ring:'ring-indigo-200'}, {id:'violet',bg:'bg-violet-400',ring:'ring-violet-200'}, {id:'purple',bg:'bg-purple-400',ring:'ring-purple-200'}, {id:'fuchsia',bg:'bg-fuchsia-400',ring:'ring-fuchsia-200'}, {id:'pink',bg:'bg-pink-400',ring:'ring-pink-200'}, {id:'rose',bg:'bg-rose-500',ring:'ring-rose-200'}
        ];

        // STATE
        let records=[]; let currentMonth=new Date(); 
        const now=new Date(); const offset=now.getTimezoneOffset()*60000; let selectedDateStr=new Date(now.getTime()-offset).toISOString().split('T')[0]; 
        let editingId=null; let isBatchMode=false; let selectedBatchIds=new Set(); let viewMode='calendar'; let pollTimer=null; let isNoteExpanded=false;
        let currentPortalRecords = []; 
        const urlParams = new URLSearchParams(window.location.search); const TARGET_SHEET = urlParams.get('db') || 'Sheet1'; 

        function applyTheme(m){ /* Keeps calendar theme consistent */ }
        window.onload = function() { 
            renderIconPicker(); renderColorPicker(); 
            if(TARGET_SHEET!=='Sheet1') document.getElementById('appTitle').innerHTML=`ConsultationDB <span class='opacity-50 text-sm font-normal'>(${TARGET_SHEET})</span>`; 
            document.getElementById('dbNameSetup').innerText=TARGET_SHEET; document.getElementById('dbNameLogin').innerText=TARGET_SHEET; 
            checkAuth(); 
        };

        function toggleElement(id,show){const e=document.getElementById(id);if(e){if(show)e.classList.remove('hidden');else e.classList.add('hidden');}}
        async function robustFetch(p){try{const r=await fetch(API_URL,{method:'POST',body:JSON.stringify(p),headers:{"Content-Type":"text/plain;charset=utf-8"}});const t=await r.text();try{return JSON.parse(t);}catch(e){if(t.trim().startsWith("<"))throw new Error("Server Error");throw new Error("Invalid Response");}}catch(e){throw e;}}
        
        async function checkAuth(){ toggleElement('authOverlay',true); toggleElement('authLoading',true); toggleElement('authSetup',false); toggleElement('authLogin',false); toggleElement('authError',false); try{const j=await robustFetch({action:'auth_check_status',db:TARGET_SHEET});toggleElement('authLoading',false);if(j.status==='setup_needed')toggleElement('authSetup',true);else if(j.status==='locked')toggleElement('authLogin',true);else if(j.error)showAuthError(j.error);}catch(e){showAuthError("Connection Failed");} }
        function showAuthError(m){ toggleElement('authLoading',false); toggleElement('authError',true); document.getElementById('errorDetail').innerText=m; }
        
        async function setupPassword(){ const p=document.getElementById('createPin').value; if(p.length<4)return alert("4+ digits"); const b=document.getElementById('btnSetup');const o=b.innerText;b.disabled=true;b.innerText="Creating..."; try{const j=await robustFetch({action:'auth_set_password',db:TARGET_SHEET,password:p});if(j.status==='success'){USER_PASSWORD=p;toggleElement('authOverlay',false);startApp();}else alert(j.error);}catch(e){alert(e.message);}finally{b.disabled=false;b.innerText=o;} }
        async function verifyPassword(){ const p=document.getElementById('loginPin').value; const b=document.getElementById('btnLogin');const o=b.innerText;b.disabled=true;b.innerText="Verifying..."; try{const j=await robustFetch({action:'auth_verify',db:TARGET_SHEET,password:p});if(j.status==='success'){USER_PASSWORD=p;toggleElement('authOverlay',false);startApp();}else{toggleElement('loginError',true);document.getElementById('loginPin').value='';}}catch(e){alert("Network Error");}finally{b.disabled=false;b.innerText=o;} }
        
        function startApp(){ toggleElement('appContainer',true); fetchData(); pollTimer=setInterval(()=>fetchData(true),POLLING_INTERVAL); }
        async function fetchData(s=false){if(!s)updateSyncStatus('Syncing...','amber');try{const j=await robustFetch({action:'read',db:TARGET_SHEET,password:USER_PASSWORD});if(j.error)throw new Error(j.error);records=j.map(r=>{const rawDC=r.is_discharged??r.isDischarged;const isDC=(rawDC===true||String(rawDC).toLowerCase()==='true'||rawDC===1||rawDC==="1");let ds=String(r.timestamp).replace(/'/g,'');if(ds.includes('T'))ds=ds.split('T')[0]; return{...r,isDischarged:isDC,timestamp:ds};}).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));renderCalendar();renderWards();updateWardSuggestions();updateSyncStatus('Live','emerald');}catch(e){if(!s){console.warn(e);updateSyncStatus('Offline','rose');}}}
        
        function manualRefresh(){ const b=document.getElementById('btnRefresh'); b.classList.add('animate-spin'); fetchData(false).then(()=>setTimeout(()=>b.classList.remove('animate-spin'),1000)); }
        function updateSyncStatus(m,c){ const l=document.getElementById('syncStatus'); const d=document.getElementById('statusDot'); const cl={'amber':'bg-amber-400','emerald':'bg-emerald-500','rose':'bg-rose-500','slate':'bg-slate-400'}; l.innerText=m; l.className=`text-[10px] font-bold uppercase tracking-wider text-${c}-500`; d.className=`w-2 h-2 rounded-full ${cl[c]||'bg-slate-400'} shadow-sm ${m==='Live'?'animate-pulse':''}`; }
        
        async function saveToBackend(payload, action="save") { if(action==='save') payload.timestamp="'"+payload.timestamp; return await robustFetch({...payload,action:action,db:TARGET_SHEET,password:USER_PASSWORD}); }
        
        function formatDateDMY(iso){if(!iso)return'';if(iso.length===10&&iso.includes('-')){const[y,m,d]=iso.split('-');return`${d}/${m}/${y}`;}return iso;}
        function generateTxtContent(r){return `Name: ${r.name||'Untitled'}\nDate: ${formatDateDMY(r.timestamp)}\nWard: ${r.ward||'Unassigned'}\n\nNote:\n${r.content||''}`;}
        function downloadFile(n,t){const b=new Blob([t],{type:"text/plain"});const u=window.URL.createObjectURL(b);const a=document.createElement("a");a.href=u;a.download=n;document.body.appendChild(a);a.click();document.body.removeChild(a);window.URL.revokeObjectURL(u);}
        function exportCurrentRecord(){if(!editingId)return;const t={name:document.getElementById('editName').value,timestamp:document.getElementById('editTimestamp').value,ward:document.getElementById('editWard').value,content:document.getElementById('editContent').value};downloadFile((t.name||'Untitled')+".txt",generateTxtContent(t));}
        async function exportBatch(){if(selectedBatchIds.size===0)return;const rs=records.filter(r=>selectedBatchIds.has(r.id));for(const r of rs){let b=(r.name||'Untitled').replace(/[/\\?%*:|"<>]/g,'-');downloadFile(b+".txt",generateTxtContent(r));await new Promise(x=>setTimeout(x,200));}}
        
        // RENDERERS
        function renderCalendar(){
            const g=document.getElementById('calendarGrid'); g.innerHTML=''; 
            const y=currentMonth.getFullYear(); const m=currentMonth.getMonth(); 
            document.getElementById('monthLabel').innerText=new Date(y,m).toLocaleString('en-US',{month:'long',year:'numeric'});
            const fd=new Date(y,m,1).getDay(); const dim=new Date(y,m+1,0).getDate();
            const now=new Date(); const offset=now.getTimezoneOffset()*60000; const todayStr=new Date(now.getTime()-offset).toISOString().split('T')[0];
            
            for(let i=0;i<fd;i++) g.innerHTML+='<div class="rounded-xl opacity-20"></div>';
            for(let d=1;d<=dim;d++){
                const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dr=records.filter(r=>r.timestamp===ds&&!r.isDischarged);
                const isT=todayStr===ds;
                const c=document.createElement('div'); 
                // Futurisitic Card Style
                c.className=`glass-card rounded-2xl p-2 relative cursor-pointer min-h-[100px] flex flex-col gap-1 group ${isT?'ring-2 ring-rose-500 shadow-glow bg-white':'hover:bg-white/80'}`;
                c.onclick=()=>openPortal(ds);
                
                let dayColor = isT ? 'text-rose-600' : 'text-slate-400';
                let html=`<div class="text-right text-sm font-extrabold mb-1 ${dayColor}">${d}</div><div class="flex flex-col gap-1.5 overflow-hidden">`;
                
                dr.slice(0,3).forEach(r=>{ 
                    const co=COLORS.find(x=>x.id===r.color)||COLORS[0]; const ic=ICONS.find(x=>x.id===r.icon)||ICONS[0]; 
                    html+=`<div class="h-6 rounded-lg px-2 flex items-center gap-1.5 text-[10px] font-bold text-white shadow-sm ${co.bg} transition transform hover:scale-105"><i class="fa-solid ${ic.icon} text-[9px] opacity-90"></i> <span class="truncate tracking-wide">${r.name||r.ward||'Case'}</span></div>`; 
                });
                if(dr.length>3) html+=`<div class="text-[9px] text-slate-400 text-center font-bold bg-slate-100 rounded-lg py-0.5">+${dr.length-3} more</div>`;
                c.innerHTML=html+'</div>'; g.appendChild(c);
            }
        }
        function changeMonth(d){currentMonth.setMonth(currentMonth.getMonth()+d);renderCalendar();}
        function goToToday(){currentMonth=new Date();const now=new Date();const offset=now.getTimezoneOffset()*60000;selectedDateStr=new Date(now.getTime()-offset).toISOString().split('T')[0];renderCalendar();}
        
        function renderWards(){
            const g=document.getElementById('wardGrid'); g.innerHTML=''; const wm={}; let dc=0;
            records.forEach(r=>{ if(r.isDischarged){dc++;}else{const w=r.ward?r.ward.trim():'Unassigned';if(!wm[w])wm[w]=0;wm[w]++;}});
            Object.entries(wm).sort().forEach(([n,c])=>{
                g.innerHTML+=`<div class="glass-card rounded-2xl p-6 cursor-pointer group relative overflow-hidden" onclick="openPortal(null,'${n}')"><div class="absolute -top-6 -right-6 w-24 h-24 bg-gradient-to-br from-slate-100 to-white rounded-full group-hover:scale-110 transition duration-500"></div><div class="relative"><h3 class="text-xl font-bold text-slate-800 mb-2 group-hover:text-primary-600 transition-colors">${n}</h3><div class="flex items-center gap-2"><span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg text-xs font-bold shadow-sm">${c} Cases</span></div></div></div>`;
            });
            if(dc>0) g.innerHTML+=`<div class="bg-rose-50 border border-rose-100 rounded-2xl p-6 hover:shadow-lg cursor-pointer group relative overflow-hidden" onclick="openPortal(null,'DISCHARGED')"><div class="absolute -top-6 -right-6 w-24 h-24 bg-rose-100/50 rounded-full group-hover:scale-110 transition duration-500"></div><div class="relative"><div class="flex items-center gap-2 mb-2"><h3 class="text-xl font-bold text-rose-700 transition-colors">Discharged</h3><i class="fa-solid fa-box-archive text-rose-400"></i></div><div class="flex items-center gap-2"><span class="bg-white text-rose-600 px-3 py-1 rounded-lg text-xs font-bold shadow-sm">${dc} Archived</span></div></div></div>`;
            if(Object.keys(wm).length===0&&dc===0) g.innerHTML=`<div class="col-span-full flex flex-col items-center justify-center text-slate-400 mt-20 opacity-50"><i class="fa-regular fa-folder-open text-5xl mb-4"></i><p>No active records</p></div>`;
        }
        function updateWardSuggestions(){ document.getElementById('wardSuggestions').innerHTML=Array.from(new Set(records.map(r=>r.ward).filter(Boolean))).map(w=>`<option value="${w}">`).join(''); }

        function openPortal(ds,wf=null){
            toggleElement('portalModal',true); setTimeout(()=>document.getElementById('portalPanel').classList.remove('translate-x-full'),10); let fr=[];
            if(ds){selectedDateStr=ds;const[y,m,d]=ds.split('-');document.getElementById('portalTitle').innerText=`${d}/${m}/${y}`;fr=records.filter(r=>r.timestamp===ds&&!r.isDischarged);toggleElement('portalFooter',true);}
            else{document.getElementById('portalTitle').innerText=wf==='DISCHARGED'?'Discharged Cases':wf;fr=wf==='DISCHARGED'?records.filter(r=>r.isDischarged):records.filter(r=>(r.ward||'Unassigned')===wf&&!r.isDischarged);toggleElement('portalFooter',false);}
            currentPortalRecords=fr; renderPortalList(); isBatchMode=false; selectedBatchIds.clear(); updateBatchUI();
        }

        function renderPortalList(){
            const l=document.getElementById('portalList'); document.getElementById('portalSubtitle').innerText=`${currentPortalRecords.length} items`; l.innerHTML='';
            currentPortalRecords.forEach(r=>{
                const c=COLORS.find(x=>x.id===r.color)||COLORS[0]; const i=ICONS.find(x=>x.id===r.icon)||ICONS[0]; const op=r.isDischarged?'opacity-75 grayscale-[0.5]':'';
                const isSelected = selectedBatchIds.has(r.id);
                // Modern Card Style
                const borderClass = isSelected ? 'border-2 border-indigo-500 ring-4 ring-indigo-50 bg-indigo-50/50' : 'border border-slate-100 bg-white hover:border-rose-200 hover:shadow-md';
                const iconCheck = isSelected ? `<i class="fa-solid fa-circle-check text-indigo-600 text-xl absolute top-4 right-4 animate-bounce"></i>` : (isBatchMode ? `<i class="fa-regular fa-circle text-slate-300 text-xl absolute top-4 right-4"></i>` : '');

                let html = `
                <div class="${borderClass} rounded-2xl p-5 transition-all duration-300 cursor-pointer relative group ${op} shadow-sm" onclick="${isBatchMode ? `toggleBatchSelect('${r.id}')` : `if(!isSwiping) openEditor('${r.id}')`}">
                    ${iconCheck}
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 shrink-0 rounded-2xl ${c.bg} text-white flex items-center justify-center shadow-md"><i class="fa-solid ${i.icon} text-lg"></i></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="block text-sm font-extrabold text-slate-800 tracking-tight">${r.name||'Untitled'}</span>
                                ${r.isDischarged?'<span class="px-2 py-0.5 rounded-md bg-slate-100 text-slate-500 text-[9px] font-bold uppercase tracking-wider">D/C</span>':''}
                            </div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">${formatDateDMY(r.timestamp)} • ${r.ward||'Gen'}</div>
                            <p class="text-slate-600 text-sm leading-relaxed font-medium line-clamp-2">${r.content.substring(0,120)+(r.content.length>120?'...':'')}</p>
                        </div>
                    </div>
                </div>`;
                
                if(!isBatchMode) {
                     l.innerHTML += `<div class="swipe-item-container mb-4 relative"><div class="swipe-actions"><button onclick="confirmDelete('${r.id}')" class="text-white font-bold flex flex-col items-center"><i class="fa-regular fa-trash-can text-xl mb-1"></i><span class="text-[10px]">DELETE</span></button></div><div class="swipe-content z-20 bg-white rounded-2xl overflow-hidden" ontouchstart="handleTouchStart(event, this)" ontouchmove="handleTouchMove(event, this)" ontouchend="handleTouchEnd(event, this)">${html}</div></div>`;
                } else {
                     l.innerHTML += `<div class="mb-4">${html}</div>`;
                }
            });
        }
        
        function toggleBatchMode(){ isBatchMode=!isBatchMode; renderPortalList(); updateBatchUI(); }
        function toggleBatchSelect(id){ if(selectedBatchIds.has(id))selectedBatchIds.delete(id); else selectedBatchIds.add(id); renderPortalList(); updateBatchUI(); }
        function updateBatchUI(){const t=document.getElementById('batchToolbar');const c=document.getElementById('batchCount');const b=document.getElementById('btnBatch');if(isBatchMode){t.classList.remove('hidden');b.classList.add('text-indigo-600','bg-indigo-50');b.classList.remove('text-slate-400');}else{t.classList.add('hidden');b.classList.remove('text-indigo-600','bg-indigo-50');b.classList.add('text-slate-400');}c.innerText=selectedBatchIds.size;}

        let xDown=null;let yDown=null;let isSwiping=false;let activeSwipeEl=null;
        function handleTouchStart(e,l){xDown=e.touches[0].clientX;yDown=e.touches[0].clientY;isSwiping=false;if(activeSwipeEl&&activeSwipeEl!==l){activeSwipeEl.style.transform="translateX(0px)";activeSwipeEl=null;}}
        function handleTouchMove(e,l){if(!xDown||!yDown)return;const xU=e.touches[0].clientX;const yU=e.touches[0].clientY;const xD=xDown-xU;const yD=yDown-yU;if(Math.abs(xD)>Math.abs(yD)){if(Math.abs(xD)>10){isSwiping=true;if(xD>0){const t=Math.min(xD,80);l.style.transform=`translateX(-${t}px)`;}else{l.style.transform=`translateX(0px)`;}}}}
        function handleTouchEnd(e,l){if(!xDown||!yDown)return;const xU=e.changedTouches[0].clientX;const xD=xDown-xU;if(xD>50){l.style.transform="translateX(-80px)";activeSwipeEl=l;}else{l.style.transform="translateX(0px)";activeSwipeEl=null;}xDown=null;yDown=null;setTimeout(()=>isSwiping=false,100);}
        function confirmDelete(id){
            if(confirm("Delete this record?")){
                const idx = records.findIndex(r => r.id === id);
                if (idx > -1) {
                    records.splice(idx, 1);
                    renderCalendar(); renderWards();
                    if(document.getElementById('portalPanel').classList.contains('translate-x-full') === false) {
                        currentPortalRecords = currentPortalRecords.filter(r => r.id !== id);
                        renderPortalList();
                    }
                }
                saveToBackend({ids:[id]},'delete').catch(e => { alert("Sync failed"); fetchData(); });
            } else { if(activeSwipeEl){activeSwipeEl.style.transform="translateX(0px)";activeSwipeEl=null;}}
        }

        // --- EDITOR & UI ---
        function closePortal(){document.getElementById('portalPanel').classList.add('translate-x-full');setTimeout(()=>toggleElement('portalModal',false),300);}
        function openEditor(id=null){ toggleElement('editorModal',true);editingId=id;isNoteExpanded=false;toggleExpandNote(false);
            if(id){
                const r=records.find(x=>x.id===id);document.getElementById('editorMode').innerText="Edit Record";toggleElement('btnDeleteRecord',true);document.getElementById('btnDeleteRecord').classList.add('flex');toggleElement('btnExportSingle',true);document.getElementById('btnExportSingle').classList.add('flex');
                document.getElementById('editTimestamp').value=r.timestamp;document.getElementById('editWard').value=r.ward;document.getElementById('editName').value=r.name||'';document.getElementById('editContent').value=r.content;document.getElementById('editDischarged').checked=!!r.isDischarged;
                selectIcon(r.icon);selectColor(r.color);
            }else{
                document.getElementById('editorMode').innerText="New Record";toggleElement('btnDeleteRecord',false);document.getElementById('btnDeleteRecord').classList.remove('flex');toggleElement('btnExportSingle',false);document.getElementById('btnExportSingle').classList.remove('flex');
                document.getElementById('editTimestamp').value=selectedDateStr;const count=records.length+1;document.getElementById('editWard').value='';document.getElementById('editName').value=`Data_${String(count).padStart(3,'0')}`;document.getElementById('editContent').value='';document.getElementById('editDischarged').checked=false;
                selectIcon(ICONS[0].id);selectColor(COLORS[0].id);
            }
        }
        function closeEditor(){toggleElement('editorModal',false);editingId=null;}
        function toggleExpandNote(fs){const t=document.getElementById('editContent');const b=document.getElementById('btnLabelExpand');const be=document.getElementById('btnExitExpand');if(!b)return;const i=b.querySelector('i');const txt=b.querySelector('span');if(typeof fs==='boolean')isNoteExpanded=fs;else isNoteExpanded=!isNoteExpanded;if(isNoteExpanded){t.classList.add('expanded-note');i.className='fa-solid fa-compress';if(txt)txt.innerText="Collapse";toggleElement('btnExitExpand',true);}else{t.classList.remove('expanded-note');i.className='fa-solid fa-expand';if(txt)txt.innerText="Expand";toggleElement('btnExitExpand',false);}}
        
        function renderIconPicker(){document.getElementById('iconPicker').innerHTML=ICONS.map(i=>`<div class="ctx-btn" data-value="${i.id}" onclick="selectIcon('${i.id}')"><i class="fa-solid ${i.icon} text-lg"></i></div>`).join('');}
        function selectIcon(id){document.getElementById('editIcon').value=id;document.querySelectorAll('.ctx-btn').forEach(b=>{if(b.dataset.value===id)b.classList.add('active');else b.classList.remove('active');});}
        function renderColorPicker(){document.getElementById('colorPicker').innerHTML=COLORS.map(c=>`<div class="color-btn ${c.bg}" data-value="${c.id}" onclick="selectColor('${c.id}')"></div>`).join('');}
        function selectColor(id){document.getElementById('editColor').value=id;document.querySelectorAll('.color-btn').forEach(b=>{if(b.dataset.value===id)b.classList.add('active');else b.classList.remove('active');});}
        
        async function saveRecord(){ 
            const btn=document.getElementById('btnSave');const org=btn.innerHTML;btn.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...';btn.disabled=true; 
            const p={id:editingId||'rec_'+Date.now()+Math.random().toString(36).substr(2,5),timestamp:document.getElementById('editTimestamp').value,ward:document.getElementById('editWard').value,name:document.getElementById('editName').value,icon:document.getElementById('editIcon').value,color:document.getElementById('editColor').value,content:document.getElementById('editContent').value,isDischarged:document.getElementById('editDischarged').checked}; 
            
            // Optimistic Update
            const existingIdx = records.findIndex(r => r.id === p.id);
            if(existingIdx > -1) records[existingIdx] = p; else records.push(p);
            
            renderCalendar(); renderWards();
            if(document.getElementById('portalPanel').classList.contains('translate-x-full') === false) {
                 if(existingIdx > -1) {
                     const portalIdx = currentPortalRecords.findIndex(r => r.id === p.id);
                     if(portalIdx > -1) currentPortalRecords[portalIdx] = p;
                 }
                 renderPortalList();
            }

            closeEditor();
            try{await saveToBackend(p,'save');}catch(e){alert("Save Failed: "+e.message);}finally{btn.innerHTML=org;btn.disabled=false;} 
        }
        
        function switchView(m){viewMode=m;const c=document.getElementById('viewCalendar');const w=document.getElementById('viewWards');const bc=document.getElementById('btnViewCal');const bw=document.getElementById('btnViewWard');if(m==='calendar'){c.classList.remove('-translate-x-full');w.classList.add('translate-x-full');bc.className="w-10 h-9 rounded-lg flex items-center justify-center transition font-medium text-white bg-rose-600 shadow-md";bw.className="w-10 h-9 rounded-lg text-slate-400 flex items-center justify-center transition hover:text-slate-600";}else{c.classList.add('-translate-x-full');w.classList.remove('translate-x-full');bw.className="w-10 h-9 rounded-lg flex items-center justify-center transition font-medium text-white bg-rose-600 shadow-md";bc.className="w-10 h-9 rounded-lg text-slate-400 flex items-center justify-center transition hover:text-slate-600";}}
        
        // --- LIGHTBOX (REMOVED) ---
        let currentLightboxImages=[]; let currentLightboxIndex=0;
        function openLightbox(i,m){} function closeLightbox(){} function nextImage(){} function prevImage(){}
        function onImageLoad(){} function onImageError(){}
    </script>
</body>
</html>
